<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>לעילוי נשמת יוסף בן כמיסה להצלחת חיילי ישראל ולשחרור החטופיים במהרה</title>
	<style>
		/* Global styling */
		body {
			font-family: Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #333;
			text-align: center;
			direction: rtl;
			margin: 0;
			padding: 20px;
			min-height: 100vh;
		}

		.container {
			max-width: 900px;
			margin: 0 auto;
			background: white;
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 15px 35px rgba(0,0,0,0.2);
		}

		/* Main title styling */
		h1 {
			color: #1e88e5;
			margin: 20px 0;
			font-size: 28px;
		}

		/* Subheading styling */
		h2 {
			color: #d32f2f;
			margin-top: 30px;
			font-size: 22px;
		}

		h3 {
			color: #4a5568;
			margin: 25px 0 15px 0;
			font-size: 20px;
		}

		/* Member buttons grid */
		#members-buttons {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 15px;
			margin: 30px 0;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 10px;
		}

		/* Member button styling */
		.member-btn {
			background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
			color: white;
			border: none;
			border-radius: 10px;
			padding: 15px 20px;
			font-size: 18px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
		}

		.member-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 6px 20px rgba(0,0,0,0.3);
		}

		/* Chapter buttons grid */
		#chapter-buttons {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			gap: 10px;
			margin: 20px 0;
			max-height: 400px;
			overflow-y: auto;
			padding: 15px;
			background: #f8f9fa;
			border-radius: 10px;
		}

		/* Chapter button styling */
		.chapter-btn {
			background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
			color: white;
			border: none;
			border-radius: 8px;
			padding: 12px 8px;
			font-size: 14px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.chapter-btn:hover {
			transform: translateY(-2px);
		}

		.chapter-btn.completed {
			background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
		}

		.chapter-btn.completed::after {
			content: ' ✓';
		}

		/* Chapter text display */
		#chapter-text {
			background: #f8f9fa;
			border-radius: 10px;
			padding: 20px;
			margin: 20px 0;
			text-align: right;
			line-height: 1.8;
			font-size: 18px;
			border: 2px solid #e2e8f0;
		}

		.chapter-title {
			font-weight: bold;
			color: #1976d2;
			font-size: 22px;
			margin-bottom: 15px;
			text-align: center;
		}

		.chapter-content {
			color: #333;
		}

		/* Admin and utility buttons */
		.admin-btn {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 8px;
			padding: 12px 20px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			margin: 10px;
			transition: all 0.3s ease;
		}

		.admin-btn:hover {
			transform: translateY(-2px);
		}

		.back-btn {
			background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
		}

		/* Progress styling */
		.progress-container {
			margin: 25px 0;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 10px;
		}

		.progress-bar {
			background: #e0e0e0;
			border-radius: 15px;
			overflow: hidden;
			height: 25px;
			margin: 15px 0;
		}

		.progress-fill {
			background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
			height: 100%;
			transition: width 0.5s ease;
			border-radius: 15px;
		}

		/* Status styling */
		.status-container {
			margin: 20px 0;
			padding: 20px;
			background: #fff;
			border-radius: 10px;
			border: 2px solid #e2e8f0;
		}

		.user-status {
			display: inline-block;
			margin: 8px;
			padding: 12px 16px;
			border-radius: 25px;
			font-size: 14px;
			font-weight: bold;
			min-width: 120px;
		}

		.completed-user {
			background: #d4edda;
			color: #155724;
			border: 2px solid #c3e6cb;
		}

		.pending-user {
			background: #fff3cd;
			color: #856404;
			border: 2px solid #ffeaa7;
		}

		/* Hidden by default */
		.hidden {
			display: none;
		}

		/* Loading animation */
		.loading {
			color: #667eea;
			font-size: 18px;
			padding: 20px;
		}

		/* Message styling */
		.message {
			padding: 15px;
			margin: 15px 0;
			border-radius: 8px;
			font-weight: bold;
		}

		.success {
			background: #d4edda;
			color: #155724;
			border: 2px solid #c3e6cb;
		}

		.error {
			background: #f8d7da;
			color: #721c24;
			border: 2px solid #f5c6cb;
		}

		/* Family info section */
		.family-info {
			background: #e3f2fd;
			border: 2px solid #2196f3;
			border-radius: 10px;
			padding: 15px;
			margin: 20px 0;
		}

		.family-name {
			font-size: 24px;
			font-weight: bold;
			color: #1976d2;
			margin-bottom: 10px;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>תהילים - ניהול משפחות</h1>
		<p style="font-size: 16px; color: #666;">לעילוי נשמת יוסף בן כמיסה להצלחת חיילי ישראל ולשחרור החטופיים במהרה</p>

		<!-- Family Info -->
		<div class="family-info" id="family-info">
			<div class="family-name" id="family-name">טוען...</div>
			<div id="family-url"></div>
		</div>

		<!-- Member Selection -->
		<div id="member-selection">
			<h3>בחרו את השם שלכם:</h3>
			<div id="members-buttons">
				<div class="loading">טוען חברי משפחה...</div>
			</div>
		</div>

		<!-- User Dashboard -->
		<div id="user-dashboard" class="hidden">
			<h2>שלום <span id="current-user-name"></span>!</h2>
			
			<div class="progress-container" id="progress-section">
				<h3>ההתקדמות שלי</h3>
				<div class="progress-bar">
					<div class="progress-fill" id="personal-progress"></div>
				</div>
				<p id="progress-text">0 מתוך 0 פרקים הושלמו</p>
			</div>

			<div id="user-chapters">
				<h3>הפרקים שלי</h3>
				<div id="chapter-buttons">
					<div class="loading">טוען פרקים...</div>
				</div>
			</div>

			<!-- Chapter Text Display -->
			<div id="chapter-text" class="hidden">
				<div class="chapter-title" id="chapter-title"></div>
				<div class="chapter-content" id="chapter-content"></div>
				<div style="text-align: center; margin-top: 20px;">
					<button class="admin-btn" id="mark-complete-btn" onclick="markCurrentChapterComplete()">סמן כהושלם</button>
					<button class="back-btn" onclick="hideChapterText()">חזרה לרשימת פרקים</button>
				</div>
			</div>

			<div style="margin-top: 30px;">
				<button class="back-btn" onclick="backToMemberSelection()">חזרה לבחירת חבר</button>
				<button class="admin-btn" onclick="showAdminPanel()">ניהול משפחה</button>
				<button class="admin-btn" onclick="loadFamilyStatus()">סטטוס משפחה</button>
			</div>
		</div>

		<!-- Family Status Section -->
		<div id="family-status-section" class="hidden">
			<h3>סטטוס כלל המשפחה</h3>
			<div class="status-container" id="status-container">
				<div class="loading">טוען סטטוס...</div>
			</div>
			<button class="back-btn" onclick="hideFamilyStatus()">סגור סטטוס</button>
		</div>

		<div id="message" class="message hidden"></div>
	</div>

	<script>
		let currentFamily = null;
		let currentUser = null;
		let familyMembers = [];
		let userParts = [];
		let completedParts = [];
		let currentChapter = null;
		const API_BASE = window.location.origin;

		// Get family name from URL path
		function getFamilyFromURL() {
			const path = window.location.pathname;
			const pathParts = path.split('/').filter(part => part);
			return pathParts.length > 0 ? pathParts[0] : null;
		}

		// Show message to user
		function showMessage(text, type = 'success') {
			const messageEl = document.getElementById('message');
			messageEl.textContent = text;
			messageEl.className = `message ${type}`;
			messageEl.classList.remove('hidden');
			setTimeout(() => {
				messageEl.classList.add('hidden');
			}, 5000);
		}

		// Load family info and members
		async function loadFamily() {
			currentFamily = getFamilyFromURL();
			
			if (!currentFamily) {
				document.getElementById('family-name').textContent = 'לא נמצא שם משפחה בכתובת';
				document.getElementById('family-url').innerHTML = 'אנא גשו לכתובת: <strong>שם-האתר/שם-המשפחה/</strong>';
				document.getElementById('members-buttons').innerHTML = '<p>אנא הוסיפו שם משפחה לכתובת</p>';
				return;
			}

			try {
				// Get family data by trying to get family status
				const response = await fetch(`${API_BASE}/${currentFamily}/status`);
				const data = await response.json();

				if (response.ok) {
					document.getElementById('family-name').textContent = `משפחת ${currentFamily}`;
					document.getElementById('family-url').textContent = `כתובת: ${window.location.href}`;
					
					familyMembers = Object.keys(data.status);
					displayMembers(familyMembers);
				} else {
					document.getElementById('family-name').textContent = `משפחת ${currentFamily} - לא נמצאה`;
					document.getElementById('members-buttons').innerHTML = '<p>המשפחה לא נמצאה במערכת</p>';
				}
			} catch (error) {
				document.getElementById('family-name').textContent = 'שגיאה בטעינת המשפחה';
				document.getElementById('members-buttons').innerHTML = '<p>שגיאה בחיבור לשרת</p>';
			}
		}

		// Display family members as clickable buttons
		function displayMembers(members) {
			const container = document.getElementById('members-buttons');
			container.innerHTML = '';

			members.forEach(member => {
				const button = document.createElement('button');
				button.className = 'member-btn';
				button.textContent = member;
				button.onclick = () => selectUser(member);
				container.appendChild(button);
			});
		}

		// Select user and load their data
		async function selectUser(userName) {
			currentUser = userName;
			document.getElementById('current-user-name').textContent = userName;

			try {
				const response = await fetch(`${API_BASE}/${currentFamily}/parts/${userName}`);
				const data = await response.json();

				if (response.ok) {
					userParts = data.userParts;
					completedParts = data.completed;
					displayUserChapters(data.userParts, data.completed);
					updatePersonalProgress(data.completed.length, data.userParts.length);
					
					// Hide member selection, show user dashboard
					document.getElementById('member-selection').classList.add('hidden');
					document.getElementById('user-dashboard').classList.remove('hidden');
					
					showMessage(`ברוכים הבאים ${userName}!`);
				} else {
					showMessage(data.error || 'שגיאה בטעינת הנתונים', 'error');
				}
			} catch (error) {
				showMessage('שגיאה בתקשורת עם השרת', 'error');
			}
		}

		// Display user chapters as clickable buttons
		function displayUserChapters(parts, completed) {
			const container = document.getElementById('chapter-buttons');
			container.innerHTML = '';

			parts.forEach(part => {
				const button = document.createElement('button');
				button.className = 'chapter-btn';
				button.textContent = `פרק ${part.id}`;
				button.onclick = () => showChapterText(part);
				
				if (completed.includes(part.id)) {
					button.classList.add('completed');
				}
				
				container.appendChild(button);
			});
		}

		// Show chapter text content
		function showChapterText(chapter) {
			currentChapter = chapter;
			
			document.getElementById('chapter-title').textContent = `פרק ${chapter.id}`;
			document.getElementById('chapter-content').textContent = chapter.text;
			
			// Check if this chapter is completed
			const isCompleted = completedParts.includes(chapter.id);
			
			const completeBtn = document.getElementById('mark-complete-btn');
			if (isCompleted) {
				completeBtn.textContent = 'הושלם ✓';
				completeBtn.style.background = '#28a745';
			} else {
				completeBtn.textContent = 'סמן כהושלם';
				completeBtn.style.background = '';
			}
			
			// Hide chapter list, show chapter text
			document.getElementById('user-chapters').classList.add('hidden');
			document.getElementById('chapter-text').classList.remove('hidden');
		}

		// Hide chapter text and show chapter list
		function hideChapterText() {
			document.getElementById('chapter-text').classList.add('hidden');
			document.getElementById('user-chapters').classList.remove('hidden');
			currentChapter = null;
		}

		// Mark current chapter as complete
		async function markCurrentChapterComplete() {
			if (!currentChapter) return;
			
			const success = await toggleCompletion(currentChapter.id);
			if (success) {
				// Update the local completedParts array
				if (!completedParts.includes(currentChapter.id)) {
					completedParts.push(currentChapter.id);
				}
				
				// Update the button appearance
				const completeBtn = document.getElementById('mark-complete-btn');
				completeBtn.textContent = 'הושלם ✓';
				completeBtn.style.background = '#28a745';
			}
		}

		// Toggle chapter completion
		async function toggleCompletion(partId) {
			if (!currentUser || !currentFamily) return false;

			try {
				const response = await fetch(`${API_BASE}/${currentFamily}/complete`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name: currentUser, partId: partId })
				});

				const data = await response.json();
				if (response.ok) {
					showMessage('הפרק סומן כהושלם!');
					return true;
				} else {
					showMessage(data.error || 'שגיאה בעדכון', 'error');
					return false;
				}
			} catch (error) {
				showMessage('שגיאה בתקשורת', 'error');
				return false;
			}
		}

		// Update personal progress
		function updatePersonalProgress(completed, total) {
			const percentage = total > 0 ? (completed / total) * 100 : 0;
			document.getElementById('personal-progress').style.width = `${percentage}%`;
			document.getElementById('progress-text').textContent = `${completed} מתוך ${total} פרקים הושלמו (${Math.round(percentage)}%)`;
		}

		// Go back to member selection
		function backToMemberSelection() {
			document.getElementById('member-selection').classList.remove('hidden');
			document.getElementById('user-dashboard').classList.add('hidden');
			document.getElementById('family-status-section').classList.add('hidden');
			document.getElementById('chapter-text').classList.add('hidden');
			document.getElementById('user-chapters').classList.remove('hidden');
			currentUser = null;
			currentChapter = null;
		}

		// Load and display family status
		async function loadFamilyStatus() {
			if (!currentFamily) return;

			try {
				const response = await fetch(`${API_BASE}/${currentFamily}/status`);
				const data = await response.json();

				if (response.ok) {
					displayFamilyStatus(data.status);
					document.getElementById('family-status-section').classList.remove('hidden');
				} else {
					showMessage(data.error || 'שגיאה בטעינת הסטטוס', 'error');
				}
			} catch (error) {
				showMessage('שגיאה בתקשורת', 'error');
			}
		}

		// Display family status
		function displayFamilyStatus(status) {
			const container = document.getElementById('status-container');
			container.innerHTML = '';

			Object.keys(status).forEach(user => {
				const userStatus = status[user];
				const percentage = userStatus.total > 0 ? (userStatus.completed.length / userStatus.total) * 100 : 0;
				
				const userEl = document.createElement('div');
				userEl.className = `user-status ${percentage === 100 ? 'completed-user' : 'pending-user'}`;
				userEl.innerHTML = `
					<strong>${user}</strong><br>
					${userStatus.completed.length}/${userStatus.total} (${Math.round(percentage)}%)
				`;
				container.appendChild(userEl);
			});
		}

		// Hide family status
		function hideFamilyStatus() {
			document.getElementById('family-status-section').classList.add('hidden');
		}

		// Show admin panel
		function showAdminPanel() {
			window.open(`${API_BASE}/admin.html`, '_blank');
		}

		// Initialize page
		window.addEventListener('load', () => {
			loadFamily();
		});
	</script>
</body>
</html>
